<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<meta name="generator" content="pdoc3 0.11.5">
<title>moog_demos.example_configs.match_to_sample API documentation</title>
<meta name="description" content="Match-to-sample task â€¦">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/sanitize.min.css" integrity="sha512-y1dtMcuvtTMJc1yPgEqF0ZjQbhnc/bFhyvIyVNb9Zk5mIGtqVaAB1Ttl28su8AvFMOY0EwRbAe+HCLqj6W7/KA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/typography.min.css" integrity="sha512-Y1DYSb995BAfxobCkKepB1BqJJTPrOp3zPL74AWFugHHmmdcvO+C48WLrUOlhGMc0QG7AE3f7gmvvcrmX2fDoA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source > summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible;min-width:max-content}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin:1em 0}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => {
hljs.configure({languages: ['bash', 'css', 'diff', 'graphql', 'ini', 'javascript', 'json', 'plaintext', 'python', 'python-repl', 'rust', 'shell', 'sql', 'typescript', 'xml', 'yaml']});
hljs.highlightAll();
/* Collapse source docstrings */
setTimeout(() => {
[...document.querySelectorAll('.hljs.language-python > .hljs-string')]
.filter(el => el.innerHTML.length > 200 && ['"""', "'''"].includes(el.innerHTML.substring(0, 3)))
.forEach(el => {
let d = document.createElement('details');
d.classList.add('hljs-string');
d.innerHTML = '<summary>"""</summary>' + el.innerHTML.substring(3);
el.replaceWith(d);
});
}, 100);
})</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>moog_demos.example_configs.match_to_sample</code></h1>
</header>
<section id="section-intro">
<p>Match-to-sample task.</p>
<p>In this task there are some colored circles (targets) on a ring, and an agent
avatar in the center of the ring. After an initial stimulus period where the
colored targets are visible, they all turn grey and begin rotating together.
After some time they stop and a colored cue appears on the agent avatar. The
subject must identify the target that had the same color as the cue and respond
by navigating towards that target.</p>
<p>This task requires workimg memory of multiple objects with features (colors).</p>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="moog_demos.example_configs.match_to_sample.get_config"><code class="name flex">
<span>def <span class="ident">get_config</span></span>(<span>num_targets)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_config(num_targets):
    &#34;&#34;&#34;Get environment config.
    
    Args:
        num_targets: Int. Number of targets.
    &#34;&#34;&#34;
    if num_targets == 0 or not isinstance(num_targets, int):
        raise ValueError(
            f&#39;num_targets is {num_targets}, but must be a positive integer&#39;)

    ############################################################################
    # State initialization
    ############################################################################

    screen = sprite.Sprite(
        x=0.5, y=0.5, shape=&#39;square&#39;, scale=2., c0=0.6, c1=0.7, c2=0.7)
        
    target_factor_distrib = distribs.Product(
        [distribs.Continuous(&#39;c0&#39;, 0., 1.)],
        shape=&#39;circle&#39;, scale=0.085, c1=1., c2=1.,
    )
    cover_factors = dict(
        mass=0., shape=&#39;circle&#39;, scale=0.1, c0=0., c1=0., c2=0.5, opacity=0)
    
    def state_initializer():
        &#34;&#34;&#34;State initializer method to be fed into environment.&#34;&#34;&#34;

        # Get targets and covers
        sprite_positions = 0.5 + 0.35 * _get_polygon(num_targets, 0.7)
        target_factors = [
            target_factor_distrib.sample() for _ in range(num_targets)]
        targets = [
            sprite.Sprite(x=pos[0], y=pos[1], **factors)
            for pos, factors in zip(sprite_positions, target_factors)
        ]
        covers = [
            sprite.Sprite(x=pos[0], y=pos[1], **cover_factors)
            for pos in sprite_positions
        ]

        # Tag the cover metadata based on whether they are prey or not
        for i, s in enumerate(covers):
            if i == 0:
                s.metadata = {&#39;prey&#39;: True}
            else:
                s.metadata = {&#39;prey&#39;: False}
        
        # Make cue have the same factors as the first target, except slightly
        # smaller
        cue_factors = copy.deepcopy(target_factors[0])
        cue_factors[&#39;scale&#39;] = 0.7 * target_factors[0][&#39;scale&#39;]
        cue = sprite.Sprite(
            x=0.5, y=0.501, opacity=0, mass=np.inf, **cue_factors)

        agent = sprite.Sprite(
            x=0.5, y=0.5, shape=&#39;circle&#39;, scale=0.1, c0=0.4, c1=0., c2=1.,
            mass=np.inf)
        annulus_verts = shapes.annulus_vertices(0.34, 0.36)
        annulus = sprite.Sprite(
            x=0.5, y=0.5, shape=annulus_verts, scale=1., c0=0., c1=0., c2=0.3)
        
        state = collections.OrderedDict([
            (&#39;annulus&#39;, [annulus]),
            (&#39;targets&#39;, targets),
            (&#39;covers&#39;, covers),
            (&#39;agent&#39;, [agent]),
            (&#39;cue&#39;, [cue]),
            (&#39;screen&#39;, [screen]),
        ])
        return state

    ################################################################################
    # Physics
    ################################################################################

    drag = (physics_lib.Drag(coeff_friction=0.25), [&#39;agent&#39;, &#39;cue&#39;])
    tether_covers = physics_lib.TetherZippedLayers(
        (&#39;targets&#39;, &#39;covers&#39;), anchor=np.array([0.5, 0.5]))
    physics = physics_lib.Physics(
        drag,
        updates_per_env_step=1,
        corrective_physics=[tether_covers],
    )

    ################################################################################
    # Task
    ################################################################################

    contact_task = tasks.ContactReward(
        reward_fn=lambda _, s: 1 if s.metadata[&#39;prey&#39;] else -1,
        layers_0=&#39;agent&#39;,
        layers_1=&#39;covers&#39;,
    )

    def _should_reset(state, meta_state):
        should_reset = (
            state[&#39;covers&#39;][0].opacity == 0 and
            meta_state[&#39;phase&#39;] == &#39;response&#39;
        )
        return should_reset
    reset_task = tasks.Reset(
        condition=_should_reset,
        steps_after_condition=15,
    )

    task = tasks.CompositeTask(contact_task, reset_task, timeout_steps=800)
    
    ################################################################################
    # Action Space
    ################################################################################

    action_space = action_spaces.Joystick(
        scaling_factor=0.01, action_layers=[&#39;agent&#39;, &#39;cue&#39;])

    ################################################################################
    # Observer
    ################################################################################

    _polygon_modifier = observers.polygon_modifiers.FirstPersonAgent(
        agent_layer=&#39;agent&#39;)
    observer = observers.PILRenderer(
        image_size=(64, 64),
        anti_aliasing=1,
        color_to_rgb=&#39;hsv_to_rgb&#39;,
        polygon_modifier=_polygon_modifier,
    )

    ############################################################################
    # Game rules
    ############################################################################

    def _make_opaque(s):
        s.opacity = 255
    def _make_transparent(s):
        s.opacity = 0

    # Screen Phase

    screen_phase = gr.Phase(duration=1, name=&#39;screen&#39;)

    # Visible Phase

    disappear_screen = gr.ModifySprites(&#39;screen&#39;, _make_transparent)
    visible_phase = gr.Phase(
        one_time_rules=disappear_screen, duration=2, name=&#39;visible&#39;)

    # Motion Phase

    def _move(s):
        s.velocity = np.random.uniform(-0.25, 0.25, size=(2,))

    cover_targets = gr.ModifySprites(&#39;covers&#39;, _make_opaque)
    begin_motion = BeginMotion(angle_vel_range=(0.1, 0.3))
    motion_phase = gr.Phase(
        one_time_rules=[cover_targets, begin_motion],
        duration=100,
        name=&#39;motion&#39;,
    )

    # Response Phase

    def _stop(s):
        s.angle_vel = 0.
        s.velocity = np.zeros(2)
    def _unglue(s):
        s.mass = 1.

    appear_cue = gr.ModifySprites(&#39;cue&#39;, _make_opaque)
    stop_targets = gr.ModifySprites((&#39;targets&#39;, &#39;covers&#39;), _stop)
    unglue_agent = gr.ModifySprites((&#39;agent&#39;, &#39;cue&#39;), _unglue)
    make_targets_discoverable = gr.ModifyOnContact(
        layers_0=&#39;agent&#39;, layers_1=&#39;covers&#39;, modifier_1=_make_transparent)

    response_phase = gr.Phase(
        one_time_rules=[appear_cue, stop_targets, unglue_agent],
        continual_rules=make_targets_discoverable,
        name=&#39;response&#39;,
    )

    phase_sequence = gr.PhaseSequence(
        screen_phase, visible_phase, motion_phase, response_phase,
        meta_state_phase_name_key=&#39;phase&#39;,
    )

    ############################################################################
    # Final config
    ############################################################################

    config = {
        &#39;state_initializer&#39;: state_initializer,
        &#39;physics&#39;: physics,
        &#39;task&#39;: task,
        &#39;action_space&#39;: action_space,
        &#39;observers&#39;: {&#39;image&#39;: observer},
        &#39;game_rules&#39;: (phase_sequence,),
        &#39;meta_state_initializer&#39;: lambda: {&#39;phase&#39;: &#39;&#39;}
    }
    return config</code></pre>
</details>
<div class="desc"><p>Get environment config.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>num_targets</code></strong></dt>
<dd>Int. Number of targets.</dd>
</dl></div>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="moog_demos.example_configs.match_to_sample.BeginMotion"><code class="flex name class">
<span>class <span class="ident">BeginMotion</span></span>
<span>(</span><span>angle_vel_range)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class BeginMotion(gr.AbstractRule):
    &#34;&#34;&#34;Custom rule for motion initiation.&#34;&#34;&#34;
    
    def __init__(self, angle_vel_range):
        &#34;&#34;&#34;Constructor.

        Args:
            angle_vel_range: Tuple of non-negative floats. Range of angular
                velocity magnitudes, in radians per step.
        &#34;&#34;&#34;
        self._angle_vel_range = angle_vel_range

    def step(self, state, meta_state):
        del meta_state
        targets = state[&#39;targets&#39;]
        covers = state[&#39;covers&#39;]
        angle_vel = np.random.uniform(*self._angle_vel_range)
        angle_vel *= (2 * np.random.randint(2) - 1)
        for t, c in zip(targets, covers):
            relative_pos = t.position - 0.5
            perpendicular = np.matmul(np.array([[0, -1], [1, 0]]), relative_pos)
            radius = np.linalg.norm(relative_pos)
            vel = perpendicular * radius * angle_vel
            t.velocity = vel
            c.velocity = vel</code></pre>
</details>
<div class="desc"><p>Custom rule for motion initiation.</p>
<p>Constructor.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>angle_vel_range</code></strong></dt>
<dd>Tuple of non-negative floats. Range of angular
velocity magnitudes, in radians per step.</dd>
</dl></div>
<h3>Ancestors</h3>
<ul class="hlist">
<li>moog.game_rules.abstract_rule.AbstractRule</li>
<li>abc.ABC</li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="moog_demos.example_configs.match_to_sample.BeginMotion.step"><code class="name flex">
<span>def <span class="ident">step</span></span>(<span>self, state, meta_state)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def step(self, state, meta_state):
    del meta_state
    targets = state[&#39;targets&#39;]
    covers = state[&#39;covers&#39;]
    angle_vel = np.random.uniform(*self._angle_vel_range)
    angle_vel *= (2 * np.random.randint(2) - 1)
    for t, c in zip(targets, covers):
        relative_pos = t.position - 0.5
        perpendicular = np.matmul(np.array([[0, -1], [1, 0]]), relative_pos)
        radius = np.linalg.norm(relative_pos)
        vel = perpendicular * radius * angle_vel
        t.velocity = vel
        c.velocity = vel</code></pre>
</details>
<div class="desc"><p>Apply rule to the environment state.</p>
<p>This method can in-place modify the state however it likes.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>state</code></strong></dt>
<dd>OrderedDict of iterables of sprites. Environment state.</dd>
<dt><strong><code>meta_state</code></strong></dt>
<dd>meta_state of environment.</dd>
</dl></div>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="moog_demos.example_configs" href="index.html">moog_demos.example_configs</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="moog_demos.example_configs.match_to_sample.get_config" href="#moog_demos.example_configs.match_to_sample.get_config">get_config</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="moog_demos.example_configs.match_to_sample.BeginMotion" href="#moog_demos.example_configs.match_to_sample.BeginMotion">BeginMotion</a></code></h4>
<ul class="">
<li><code><a title="moog_demos.example_configs.match_to_sample.BeginMotion.step" href="#moog_demos.example_configs.match_to_sample.BeginMotion.step">step</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.5</a>.</p>
</footer>
</body>
</html>
